generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== PERSONEL ====================
enum PersonelRol {
  ADMIN
  YONETICI
  PERSONEL
}

model Personel {
  id        String      @id @default(cuid())
  visibleId String      @unique // 6 haneli kimlik
  ad        String
  soyad     String
  parola    String
  rol       PersonelRol @default(PERSONEL)
  fotograf  String?     // Profil fotoğrafı URL
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Iliskiler - olusturan/guncelleyen olarak
  createdKisiler    Kisi[]    @relation("KisiCreatedBy")
  updatedKisiler    Kisi[]    @relation("KisiUpdatedBy")
  createdGsmler     Gsm[]     @relation("GsmCreatedBy")
  updatedGsmler     Gsm[]     @relation("GsmUpdatedBy")
  createdAdresler   Adres[]   @relation("AdresCreatedBy")
  updatedAdresler   Adres[]   @relation("AdresUpdatedBy")
  createdTakipler   Takip[]   @relation("TakipCreatedBy")
  updatedTakipler   Takip[]   @relation("TakipUpdatedBy")
  createdNotlar     Not[]     @relation("NotCreatedBy")
  createdTanitimlar Tanitim[] @relation("TanitimCreatedBy")
  updatedTanitimlar Tanitim[] @relation("TanitimUpdatedBy")

  // Lokasyon iliskileri
  createdIller      Il[]      @relation("IlCreatedBy")
  updatedIller      Il[]      @relation("IlUpdatedBy")
  createdIlceler    Ilce[]    @relation("IlceCreatedBy")
  updatedIlceler    Ilce[]    @relation("IlceUpdatedBy")
  createdMahalleler Mahalle[] @relation("MahalleCreatedBy")
  updatedMahalleler Mahalle[] @relation("MahalleUpdatedBy")

  @@map("personeller")
}

// ==================== KISI (Müşteri + Lead Birleşimi) ====================
enum KisiTip {
  LEAD
  MUSTERI
}

model Kisi {
  id         String   @id @default(cuid())
  tip        KisiTip  @default(LEAD)
  tc         String?  @unique // TC Kimlik No
  ad         String
  soyad      String
  faaliyet   String?  // Richtext
  pio        Boolean  @default(false)
  asli       Boolean  @default(false)
  fotograf   String?  // URL/path
  isArchived Boolean  @default(false)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("KisiCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("KisiUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  gsmler       Gsm[]
  adresler     Adres[]
  notlar       Not[]
  tanitimlar   TanitimKatilimci[]

  @@index([ad, soyad])
  @@index([tc])
  @@index([tip])
  @@map("kisiler")
}

// ==================== GSM ====================
model Gsm {
  id        String  @id @default(cuid())
  numara    String
  kisiId    String
  kisi      Kisi    @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  isPrimary Boolean @default(false)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("GsmCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("GsmUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  takipler Takip[]

  @@index([numara])
  @@index([kisiId])
  @@map("gsmler")
}

// ==================== LOKASYON MODELLERI ====================
model Il {
  id       String  @id @default(cuid())
  ad       String  @unique
  plaka    Int?    @unique
  isActive Boolean @default(true)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("IlCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("IlUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  ilceler Ilce[]

  @@map("iller")
}

model Ilce {
  id       String  @id @default(cuid())
  ad       String
  ilId     String
  il       Il      @relation(fields: [ilId], references: [id])
  isActive Boolean @default(true)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("IlceCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("IlceUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  mahalleler Mahalle[]

  @@unique([ilId, ad])
  @@map("ilceler")
}

model Mahalle {
  id       String  @id @default(cuid())
  ad       String
  ilceId   String
  ilce     Ilce    @relation(fields: [ilceId], references: [id])
  isActive Boolean @default(true)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("MahalleCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("MahalleUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  adresler Adres[]

  @@unique([ilceId, ad])
  @@map("mahalleler")
}

// ==================== ADRES ====================
model Adres {
  id        String  @id @default(cuid())
  ad        String? // Adres adı (Ev, İş, vb.)
  mahalleId String
  mahalle   Mahalle @relation(fields: [mahalleId], references: [id])
  detay     String? // Detaylı adres bilgisi - kapi no, daire vs.
  kisiId    String
  kisi      Kisi    @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  isPrimary Boolean @default(false)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("AdresCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("AdresUpdatedBy", fields: [updatedUserId], references: [id])

  @@index([kisiId])
  @@map("adresler")
}

// ==================== TAKIP ====================
enum TakipDurum {
  UZATILACAK
  DEVAM_EDECEK
  SONLANDIRILACAK
  UZATILDI
}

model Takip {
  id            String     @id @default(cuid())
  gsmId         String
  gsm           Gsm        @relation(fields: [gsmId], references: [id], onDelete: Cascade)
  baslamaTarihi DateTime   @default(now())
  bitisTarihi   DateTime   // Default: baslamaTarihi + 90 gun
  durum         TakipDurum @default(UZATILACAK)
  isActive      Boolean    @default(true) // Her GSM için sadece 1 aktif takip olabilir

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("TakipCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("TakipUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  alarmlar Alarm[]

  @@index([gsmId])
  @@index([isActive])
  @@index([bitisTarihi])
  @@map("takipler")
}

// ==================== ALARM ====================
enum AlarmTip {
  TAKIP_BITIS
  ODEME_HATIRLATMA
  OZEL
}

enum AlarmDurum {
  BEKLIYOR
  TETIKLENDI
  ONAYLANDI
  IPTAL
}

model Alarm {
  id          String     @id @default(cuid())
  takipId     String?
  takip       Takip?     @relation(fields: [takipId], references: [id], onDelete: Cascade)
  tip         AlarmTip
  tetikTarihi DateTime
  mesaj       String?
  durum       AlarmDurum @default(BEKLIYOR)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tetikTarihi])
  @@index([durum])
  @@map("alarmlar")
}

// ==================== NOT ====================
model Not {
  id            String    @id @default(cuid())
  kisiId        String
  kisi          Kisi      @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  icerik        String    // Richtext
  createdAt     DateTime  @default(now())
  createdUserId String?
  createdUser   Personel? @relation("NotCreatedBy", fields: [createdUserId], references: [id])

  @@index([kisiId])
  @@map("notlar")
}

// ==================== TANITIM ====================
model Tanitim {
  id     String   @id @default(cuid())
  tarih  DateTime @default(now())
  adres  String?  // Tanitim yapilan adres
  notlar String?

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("TanitimCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("TanitimUpdatedBy", fields: [updatedUserId], references: [id])

  // Coklu katilimci iliskisi
  katilimcilar TanitimKatilimci[]

  @@index([tarih])
  @@map("tanitimlar")
}

model TanitimKatilimci {
  id        String   @id @default(cuid())
  tanitimId String
  tanitim   Tanitim  @relation(fields: [tanitimId], references: [id], onDelete: Cascade)
  kisiId    String?
  kisi      Kisi?    @relation(fields: [kisiId], references: [id])
  gsmId     String?  // Hangi GSM ile iletisim kuruldu

  @@unique([tanitimId, kisiId])
  @@map("tanitim_katilimcilari")
}
