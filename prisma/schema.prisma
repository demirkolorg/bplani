generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== PERSONEL ====================
enum PersonelRol {
  ADMIN
  YONETICI
  PERSONEL
}

model Personel {
  id          String      @id @default(cuid())
  visibleId   String      @unique // 6 haneli kimlik
  ad          String
  soyad       String
  parola      String
  rol         PersonelRol @default(PERSONEL)
  fotograf    String?     // Profil fotoğrafı URL
  isActive    Boolean     @default(true)
  lastLoginAt DateTime?   // Son giriş zamanı
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Iliskiler - olusturan/guncelleyen olarak
  createdKisiler    Kisi[]    @relation("KisiCreatedBy")
  updatedKisiler    Kisi[]    @relation("KisiUpdatedBy")
  createdGsmler     Gsm[]     @relation("GsmCreatedBy")
  updatedGsmler     Gsm[]     @relation("GsmUpdatedBy")
  createdAdresler   Adres[]   @relation("AdresCreatedBy")
  updatedAdresler   Adres[]   @relation("AdresUpdatedBy")
  createdTakipler   Takip[]   @relation("TakipCreatedBy")
  updatedTakipler   Takip[]   @relation("TakipUpdatedBy")
  createdNotlar     Not[]     @relation("NotCreatedBy")
  createdTanitimlar Tanitim[] @relation("TanitimCreatedBy")
  updatedTanitimlar Tanitim[] @relation("TanitimUpdatedBy")
  createdOperasyonlar Operasyon[] @relation("OperasyonCreatedBy")
  updatedOperasyonlar Operasyon[] @relation("OperasyonUpdatedBy")

  // Lokasyon iliskileri
  createdIller      Il[]      @relation("IlCreatedBy")
  updatedIller      Il[]      @relation("IlUpdatedBy")
  createdIlceler    Ilce[]    @relation("IlceCreatedBy")
  updatedIlceler    Ilce[]    @relation("IlceUpdatedBy")
  createdMahalleler Mahalle[] @relation("MahalleCreatedBy")
  updatedMahalleler Mahalle[] @relation("MahalleUpdatedBy")

  // Alarm iliskileri
  createdAlarmlar Alarm[] @relation("AlarmCreatedBy")

  // Araç tanımları iliskileri
  createdMarkalar Marka[] @relation("MarkaCreatedBy")
  updatedMarkalar Marka[] @relation("MarkaUpdatedBy")
  createdModeller Model[] @relation("ModelCreatedBy")
  updatedModeller Model[] @relation("ModelUpdatedBy")
  createdAraclar  Arac[]  @relation("AracCreatedBy")
  updatedAraclar  Arac[]  @relation("AracUpdatedBy")

  // Log iliskileri
  loglar Log[] @relation("LogUser")

  // Faaliyet Alanı iliskileri
  createdFaaliyetAlanlari FaaliyetAlani[] @relation("FaaliyetAlaniCreatedBy")
  updatedFaaliyetAlanlari FaaliyetAlani[] @relation("FaaliyetAlaniUpdatedBy")

  // Kullanıcı tercihleri
  tercihler KullaniciTercihi[]

  @@map("personeller")
}

// ==================== KISI (Müşteri + Lead Birleşimi) ====================
model Kisi {
  id         String   @id @default(cuid())
  tt         Boolean  @default(false) // true = Müşteri, false = Aday
  tc         String?  @unique // TC Kimlik No
  ad         String
  soyad      String
  faaliyet   String?  // Richtext
  pio        Boolean  @default(false)
  asli       Boolean  @default(false)
  fotograf   String?  // URL/path
  isArchived Boolean  @default(false)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("KisiCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("KisiUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  gsmler           Gsm[]
  adresler         Adres[]
  notlar           Not[]
  tanitimlar       TanitimKatilimci[]
  operasyonlar     OperasyonKatilimci[]
  araclar          AracKisi[]
  faaliyetAlanlari KisiFaaliyetAlani[]

  @@index([ad, soyad])
  @@index([tc])
  @@index([tt])
  @@map("kisiler")
}

// ==================== GSM ====================
model Gsm {
  id        String  @id @default(cuid())
  numara    String
  kisiId    String
  kisi      Kisi    @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  isPrimary Boolean @default(false)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("GsmCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("GsmUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  takipler Takip[]

  @@index([numara])
  @@index([kisiId])
  @@map("gsmler")
}

// ==================== LOKASYON MODELLERI ====================
model Il {
  id       String  @id @default(cuid())
  ad       String  @unique
  plaka    Int?    @unique
  isActive Boolean @default(true)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("IlCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("IlUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  ilceler Ilce[]

  @@map("iller")
}

model Ilce {
  id       String  @id @default(cuid())
  ad       String
  ilId     String
  il       Il      @relation(fields: [ilId], references: [id])
  isActive Boolean @default(true)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("IlceCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("IlceUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  mahalleler Mahalle[]

  @@unique([ilId, ad])
  @@map("ilceler")
}

model Mahalle {
  id       String  @id @default(cuid())
  ad       String
  ilceId   String
  ilce     Ilce    @relation(fields: [ilceId], references: [id])
  isActive Boolean @default(true)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("MahalleCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("MahalleUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  adresler    Adres[]
  tanitimlar  Tanitim[]
  operasyonlar Operasyon[]

  @@unique([ilceId, ad])
  @@map("mahalleler")
}

// ==================== ADRES ====================
model Adres {
  id        String  @id @default(cuid())
  ad        String? // Adres adı (Ev, İş, vb.)
  mahalleId String
  mahalle   Mahalle @relation(fields: [mahalleId], references: [id])
  detay     String? // Detaylı adres bilgisi - kapi no, daire vs.
  kisiId    String
  kisi      Kisi    @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  isPrimary Boolean @default(false)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("AdresCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("AdresUpdatedBy", fields: [updatedUserId], references: [id])

  @@index([kisiId])
  @@map("adresler")
}

// ==================== TAKIP ====================
enum TakipDurum {
  UZATILACAK
  DEVAM_EDECEK
  SONLANDIRILACAK
  UZATILDI
}

model Takip {
  id            String     @id @default(cuid())
  gsmId         String
  gsm           Gsm        @relation(fields: [gsmId], references: [id], onDelete: Cascade)
  baslamaTarihi DateTime   @default(now())
  bitisTarihi   DateTime   // Default: baslamaTarihi + 90 gun
  durum         TakipDurum @default(UZATILACAK)
  isActive      Boolean    @default(true) // Her GSM için sadece 1 aktif takip olabilir

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("TakipCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("TakipUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  alarmlar Alarm[]

  @@index([gsmId])
  @@index([isActive])
  @@index([bitisTarihi])
  @@map("takipler")
}

// ==================== ALARM ====================
enum AlarmTip {
  TAKIP_BITIS
  ODEME_HATIRLATMA
  OZEL
}

enum AlarmDurum {
  BEKLIYOR
  TETIKLENDI
  GORULDU
  IPTAL
}

model Alarm {
  id          String     @id @default(cuid())
  takipId     String?
  takip       Takip?     @relation(fields: [takipId], references: [id], onDelete: Cascade)
  tip         AlarmTip
  baslik      String?    // Alarm başlığı
  mesaj       String?    // Detaylı mesaj
  tetikTarihi DateTime   // Alarmın tetikleneceği tarih
  gunOnce     Int        @default(20) // Bitiş tarihinden kaç gün önce
  isPaused    Boolean    @default(false) // Duraklatılmış mı
  durum       AlarmDurum @default(BEKLIYOR)

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  createdUser   Personel? @relation("AlarmCreatedBy", fields: [createdUserId], references: [id])

  @@index([tetikTarihi])
  @@index([durum])
  @@index([isPaused])
  @@map("alarmlar")
}

// ==================== ALARM AYARLARI ====================
model AlarmAyar {
  id                   String  @id @default(cuid())
  key                  String  @unique // Ayar anahtarı (örn: "default_gun_once")
  value                String  // Ayar değeri
  aciklama             String? // Ayar açıklaması

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("alarm_ayarlari")
}

// ==================== NOT ====================
model Not {
  id            String    @id @default(cuid())
  kisiId        String
  kisi          Kisi      @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  icerik        String    // Richtext
  createdAt     DateTime  @default(now())
  createdUserId String?
  createdUser   Personel? @relation("NotCreatedBy", fields: [createdUserId], references: [id])

  @@index([kisiId])
  @@map("notlar")
}

// ==================== TANITIM ====================
model Tanitim {
  id         String   @id @default(cuid())
  tarih      DateTime @default(now())
  saat       String?  // Opsiyonel saat bilgisi "HH:mm" formatında
  mahalleId  String?
  mahalle    Mahalle? @relation(fields: [mahalleId], references: [id])
  adresDetay String?  // Sokak, bina no, daire vs.
  notlar     String?

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("TanitimCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("TanitimUpdatedBy", fields: [updatedUserId], references: [id])

  // Coklu katilimci iliskisi
  katilimcilar TanitimKatilimci[]

  @@index([tarih])
  @@index([mahalleId])
  @@map("tanitimlar")
}

model TanitimKatilimci {
  id        String   @id @default(cuid())
  tanitimId String
  tanitim   Tanitim  @relation(fields: [tanitimId], references: [id], onDelete: Cascade)
  kisiId    String?
  kisi      Kisi?    @relation(fields: [kisiId], references: [id])
  gsmId     String?  // Hangi GSM ile iletisim kuruldu

  @@unique([tanitimId, kisiId])
  @@map("tanitim_katilimcilari")
}

// ==================== OPERASYON ====================
model Operasyon {
  id         String   @id @default(cuid())
  tarih      DateTime @default(now())
  saat       String?  // Opsiyonel saat bilgisi "HH:mm" formatında
  mahalleId  String?
  mahalle    Mahalle? @relation(fields: [mahalleId], references: [id])
  adresDetay String?  // Sokak, bina no, daire vs.
  notlar     String?

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("OperasyonCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("OperasyonUpdatedBy", fields: [updatedUserId], references: [id])

  // Coklu katilimci iliskisi
  katilimcilar OperasyonKatilimci[]

  @@index([tarih])
  @@index([mahalleId])
  @@map("operasyonlar")
}

model OperasyonKatilimci {
  id          String     @id @default(cuid())
  operasyonId String
  operasyon   Operasyon  @relation(fields: [operasyonId], references: [id], onDelete: Cascade)
  kisiId      String?
  kisi        Kisi?      @relation(fields: [kisiId], references: [id])
  gsmId       String?    // Hangi GSM ile iletisim kuruldu

  @@unique([operasyonId, kisiId])
  @@map("operasyon_katilimcilari")
}

// ==================== ARAÇ TANIMLARI ====================
model Marka {
  id String @id @default(cuid())
  ad String @unique

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("MarkaCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("MarkaUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  modeller Model[]

  @@map("markalar")
}

model Model {
  id      String @id @default(cuid())
  ad      String
  markaId String
  marka   Marka  @relation(fields: [markaId], references: [id])

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("ModelCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("ModelUpdatedBy", fields: [updatedUserId], references: [id])

  // Iliskiler
  araclar Arac[]

  @@unique([markaId, ad])
  @@index([markaId])
  @@map("modeller")
}

// ==================== ARAÇLAR (Vehicles) ====================
enum AracRenk {
  BEYAZ
  SIYAH
  GRI
  GUMUS
  KIRMIZI
  MAVI
  LACIVERT
  YESIL
  SARI
  TURUNCU
  KAHVERENGI
  BEJ
  BORDO
  MOR
  PEMBE
  ALTIN
  BRONZ
  DIGER
}

model Arac {
  id      String    @id @default(cuid())
  modelId String
  model   Model     @relation(fields: [modelId], references: [id])
  renk    AracRenk?
  plaka   String    @unique

  // Loglama
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("AracCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("AracUpdatedBy", fields: [updatedUserId], references: [id])

  // Many-to-many with Kisi
  kisiler AracKisi[]

  @@index([modelId])
  @@index([plaka])
  @@map("araclar")
}

model AracKisi {
  id       String  @id @default(cuid())
  aracId   String
  arac     Arac    @relation(fields: [aracId], references: [id], onDelete: Cascade)
  kisiId   String
  kisi     Kisi    @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  aciklama String? // Neden bu araç bu kişiye eklendi

  createdAt DateTime @default(now())

  @@unique([aracId, kisiId])
  @@index([aracId])
  @@index([kisiId])
  @@map("arac_kisileri")
}

// ==================== AKTIVITE LOG ====================
enum LogIslem {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  LOGIN_FAIL
  BULK_CREATE
  BULK_UPDATE
  BULK_DELETE
  STATUS_CHANGE
  EXPORT
}

model Log {
  id          String    @id @default(cuid())

  // Kim yaptı
  userId      String?
  user        Personel? @relation("LogUser", fields: [userId], references: [id])
  userAd      String?   // Snapshot: Kullanıcı adı
  userSoyad   String?   // Snapshot: Kullanıcı soyadı

  // Ne yapıldı
  islem       LogIslem
  aciklama    String?   // İşlem açıklaması

  // Hangi veri etkilendi
  entityType  String?   // Tablo/Model adı (Kisi, Takip, Gsm, vs.)
  entityId    String?   // Etkilenen kaydın ID'si
  entityAd    String?   // Snapshot: Etkilenen kaydın adı/başlığı

  // Değişiklik detayları
  oncekiVeri  Json?     // Önceki veri (UPDATE ve DELETE için)
  yeniVeri    Json?     // Yeni veri (CREATE ve UPDATE için)
  degisiklikler Json?   // Sadece değişen alanlar

  // Ek bilgiler
  ipAdresi    String?
  userAgent   String?
  metadata    Json?     // Ek bilgiler

  // Zaman
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([islem])
  @@index([createdAt])
  @@map("loglar")
}

// ==================== FAALIYET ALANI ====================
model FaaliyetAlani {
  id        String  @id @default(cuid())
  ad        String
  parentId  String?
  parent    FaaliyetAlani?  @relation("FaaliyetHierarchy", fields: [parentId], references: [id])
  children  FaaliyetAlani[] @relation("FaaliyetHierarchy")
  sira      Int     @default(0)
  isActive  Boolean @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdUserId String?
  updatedUserId String?
  createdUser   Personel? @relation("FaaliyetAlaniCreatedBy", fields: [createdUserId], references: [id])
  updatedUser   Personel? @relation("FaaliyetAlaniUpdatedBy", fields: [updatedUserId], references: [id])

  kisiler KisiFaaliyetAlani[]

  @@unique([parentId, ad])
  @@index([parentId])
  @@map("faaliyet_alanlari")
}

model KisiFaaliyetAlani {
  id              String        @id @default(cuid())
  kisiId          String
  kisi            Kisi          @relation(fields: [kisiId], references: [id], onDelete: Cascade)
  faaliyetAlaniId String
  faaliyetAlani   FaaliyetAlani @relation(fields: [faaliyetAlaniId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([kisiId, faaliyetAlaniId])
  @@index([kisiId])
  @@index([faaliyetAlaniId])
  @@map("kisi_faaliyet_alanlari")
}

// ==================== KULLANICI TERCİHLERİ ====================
// Esnek anahtar-değer yapısı ile kullanıcı tercihlerini saklar
// Kategoriler: "tablo", "tema", "genel"
// Örnek anahtarlar:
//   - tablo: "kisiler", "takipler", "tanitimlar"
//   - tema: "mode" (dark/light)
//   - genel: "sidebar", "notifications"
model KullaniciTercihi {
  id         String   @id @default(cuid())
  personelId String
  personel   Personel @relation(fields: [personelId], references: [id], onDelete: Cascade)
  kategori   String   // "tablo", "tema", "genel"
  anahtar    String   // Kategori içindeki spesifik tercih (ör: "kisiler", "mode")
  deger      Json     // Tercih değeri (JSON formatında esnek yapı)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([personelId, kategori, anahtar])
  @@index([personelId])
  @@index([kategori])
  @@map("kullanici_tercihleri")
}
